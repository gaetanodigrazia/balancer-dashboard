<h2 class="fw-bold text-primary mb-4">üçΩÔ∏è Gestione Schema Nutrizionale</h2>

<div class="row gx-4 gy-4">

  <!-- Card Dati Generali -->
  <div class="col-md-5">
    <div class="card shadow-sm p-4 border-0 rounded-4 bg-white h-100">
      <h5 class="mb-4">üìù Dati Generali Schema</h5>
      <form (submit)="inviaDatiGenerali(); $event.preventDefault()" novalidate>
        <div class="mb-3">
          <label for="nome" class="form-label fw-semibold">Nome schema:</label>
          <input
            id="nome"
            type="text"
            class="form-control"
            [(ngModel)]="nome"
            name="nome"
            required
            autocomplete="off"
          />
        </div>
        <div class="mb-3">
          <label for="calorie" class="form-label fw-semibold">Calorie:</label>
          <input
            id="calorie"
            type="number"
            class="form-control"
            [(ngModel)]="calorie"
            name="calorie"
            min="0"
            step="0.01"
            required
          />
        </div>
        <div class="mb-3">
          <label for="carboidrati" class="form-label fw-semibold">Carboidrati (g):</label>
          <input
            id="carboidrati"
            type="number"
            class="form-control"
            [(ngModel)]="carboidrati"
            name="carboidrati"
            min="0"
            step="0.01"
            required
          />
        </div>
        <div class="mb-3">
          <label for="grassi" class="form-label fw-semibold">Grassi (g):</label>
          <input
            id="grassi"
            type="number"
            class="form-control"
            [(ngModel)]="grassi"
            name="grassi"
            min="0"
            step="0.01"
            required
          />
        </div>
        <div class="mb-3">
          <label for="proteine" class="form-label fw-semibold">Proteine (g):</label>
          <input
            id="proteine"
            type="number"
            class="form-control"
            [(ngModel)]="proteine"
            name="proteine"
            min="0"
            step="0.01"
            required
          />
        </div>
        <div class="mb-3">
          <label for="acqua" class="form-label fw-semibold">Acqua (L):</label>
          <input
            id="acqua"
            type="number"
            class="form-control"
            [(ngModel)]="acqua"
            name="acqua"
            min="0"
            step="0.01"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary w-100" [disabled]="loadingDatiGenerali">
          Salva Dati Generali
        </button>

        <div *ngIf="loadingDatiGenerali" class="text-center mt-3 text-muted fst-italic">Salvataggio in corso...</div>
        <div *ngIf="messageDatiGenerali" class="text-success mt-3 fw-semibold">{{ messageDatiGenerali }}</div>
        <div *ngIf="errorDatiGenerali" class="text-danger mt-3 fw-semibold">{{ errorDatiGenerali }}</div>
      </form>
    </div>
  </div>

  <!-- Card Opzioni Pasto -->
  <div class="col-md-7">
    <div class="card shadow-sm p-4 border-0 rounded-4 bg-white h-100">
      <h5 class="mb-4">üç¥ Opzioni Pasti</h5>

      <!-- Dropdown Tipo Schema -->
      <div class="mb-4">
        <label for="tipoSchema" class="form-label fw-semibold">Tipo schema:</label>
<select
  id="tipoSchema"
  class="form-select"
  [(ngModel)]="tipoSchemaSelezionato"
  name="tipoSchema"
  required
>
  <option value="" disabled>Seleziona tipo schema</option>
  <option *ngFor="let schema of schemiDisponibili" [value]="schema.id">
    {{ schema.nome }}
  </option>
</select>
      </div>

      <!-- Dropdown Tipo Pasto, visibile solo se tipoSchema selezionato -->
      <!-- <div class="mb-4" *ngIf="tipoSchemaSelezionato">-->
      <div class="mb-4">
        <label for="tipoPasto" class="form-label fw-semibold">Tipo pasto:</label>
        <select
          id="tipoPasto"
          class="form-select"
          [(ngModel)]="tipoPastoSelezionato"
          name="tipoPasto"
          required
        >
          <option value="" disabled>Seleziona tipo pasto</option>
          <option *ngFor="let pasto of tipiPasto" [value]="pasto">{{ pasto | titlecase }}</option>
        </select>
      </div>

      <div *ngIf="tipoPastoSelezionato">
        <button type="button" class="btn btn-sm btn-success mb-3" (click)="aggiungiOpzioneDinamica()">
          + Aggiungi opzione
        </button>
<div *ngFor="let opzione of opzioniDinamiche; let i = index" class="border rounded-3 p-3 mb-3 bg-light">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <strong>Opzione {{ i + 1 }}</strong>
    <button type="button" class="btn btn-sm btn-danger" (click)="rimuoviOpzioneDinamica(i)">
      Rimuovi opzione
    </button>
  </div>

  <div *ngFor="let alimento of opzione; let j = index" class="mb-3 border rounded p-2 bg-white">
    <!-- Macronutriente dropdown -->
    <select
      class="form-select form-select-sm mb-2"
      [(ngModel)]="alimento.macronutriente"
      name="alimentoMacro{{i}}{{j}}"
      required
      style="max-width: 180px;"
    >
      <option value="" disabled>Seleziona macronutriente</option>
      <option value="carboidrati">Carboidrati</option>
      <option value="grassi">Grassi</option>
      <option value="proteine">Proteine</option>
      <option value="gruppo">Gruppo</option>
    </select>

    <!-- Se macronutriente √® gruppo, mostra lista alimenti multipli -->
    <div *ngIf="alimento.macronutriente === 'gruppo'">
      <div *ngFor="let subAlimento of alimento.gruppoAlimenti; let k = index" class="d-flex align-items-center mb-2 gap-2 flex-wrap">
        <input
          type="text"
          class="form-control form-control-sm flex-grow-1"
          [(ngModel)]="subAlimento.nome"
          name="gruppoNome{{i}}{{j}}{{k}}"
          placeholder="Nome alimento gruppo"
          required
          autocomplete="off"
        />
        <select
          class="form-select form-select-sm"
          [(ngModel)]="subAlimento.macronutriente"
          name="gruppoMacro{{i}}{{j}}{{k}}"
          required
          style="max-width: 150px;"
        >
          <option value="" disabled>Macronutriente</option>
          <option value="carboidrati">Carboidrati</option>
          <option value="grassi">Grassi</option>
          <option value="proteine">Proteine</option>
        </select>
        <input
          type="number"
          class="form-control form-control-sm"
          [(ngModel)]="subAlimento.grammi"
          name="gruppoGrammi{{i}}{{j}}{{k}}"
          placeholder="Grammi"
          min="0"
          step="0.01"
          required
          style="max-width: 120px;"
        />
        <button
          type="button"
          class="btn btn-sm btn-outline-danger"
          (click)="rimuoviSubAlimento(i, j, k)"
          title="Rimuovi alimento gruppo"
        >
          &times;
        </button>
      </div>
      <button type="button" class="btn btn-sm btn-success mt-2" (click)="aggiungiSubAlimento(i, j)">
        + Aggiungi alimento gruppo
      </button>
    </div>

    <!-- Se macronutriente NON √® gruppo, mostra nome e grammi normali -->
    <div *ngIf="alimento.macronutriente !== 'gruppo'">
      <input
        type="text"
        class="form-control form-control-sm mb-2"
        [(ngModel)]="alimento.nome"
        name="alimentoNome{{i}}{{j}}"
        placeholder="Nome alimento"
        required
        autocomplete="off"
      />
      <input
        type="number"
        class="form-control form-control-sm"
        [(ngModel)]="alimento.grammi"
        name="alimentoGrammi{{i}}{{j}}"
        placeholder="Grammi"
        min="0"
        step="0.01"
        required
        style="max-width: 120px;"
      />
    </div>

    <button
      type="button"
      class="btn btn-sm btn-outline-danger mt-2"
      (click)="rimuoviAlimentoDinamico(i, j)"
      title="Rimuovi alimento"
    >
      &times;
    </button>
  </div>

  <button type="button" class="btn btn-sm btn-success mt-2" (click)="aggiungiAlimentoDinamico(i)">
    + Aggiungi alimento
  </button>
</div>


      <button
        type="button"
        class="btn btn-primary w-100 mt-3"
        (click)="inviaSchemaCompleto()"
        [disabled]="loadingSchemaCompleto"
      >
        Salva Opzioni Pasti
      </button>

      <div *ngIf="loadingSchemaCompleto" class="text-center mt-3 text-muted fst-italic">Salvataggio in corso...</div>
      <div *ngIf="messageSchemaCompleto" class="text-success mt-3 fw-semibold">{{ messageSchemaCompleto }}</div>
      <div *ngIf="errorSchemaCompleto" class="text-danger mt-3 fw-semibold">{{ errorSchemaCompleto }}</div>
    </div>
  </div>
</div>
